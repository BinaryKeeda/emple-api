# version: '3.8'

# services:
#   api-core-node:
#     container_name: api_core_node
#     build:
#       context: .
#       dockerfile: Dockerfile
#     image: binarykeeda-api
#     ports:
#       - "5000:5000"
#     env_file:
#       - bk.conf
#     command: npm run api
#     healthcheck:
#       test: [ 'CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5001' ]
#       interval: 1m30s
#       timeout: 30s
#       retries: 5
#       start_period: 30s

#   evaluator-node:
#     container_name: evaluator_node
#     build:
#       context: .
#       dockerfile: Dockerfile
#     image: binarykeeda-evaluator
#     ports:
#       - "3001:3001"
#     env_file:
#       - .env
#     command: npm run evaluator
#     healthcheck:
#       test: [ 'CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3001' ]
#       interval: 1m30s
#       timeout: 30s
#       retries: 5
#       start_period: 30s

#   worker:
#     container_name: worker
#     build:
#       context: .
#       dockerfile: Dockerfile
#     image: binarykeeda-worker
#     env_file:
#       - bk.conf
#     command: npm run worker
#     # healthcheck:
#     #   test: [ 'CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3000' ]
#     #   interval: 1m30s
#     #   timeout: 30s
#     #   retries: 5
#     #   start_period: 30s

#   campusworker:
#     container_name: campusworker
#     image: binarykeeda-campusworker
#     env_file:
#       - bk.conf
#     build:
#       context: .
#       dockerfile: Dockerfile
#     command: npm run campusworker
#     restart: always
#     # 3 retry
#     # healthcheck:
#     #   test: [ "executable", "arg" ]
#     #   interval: 1m30s
#     #   timeout: 30s
#     #   retries: 5
#     #   start_period: 30s
#   # atsnode:
#   #   container_name: atsnode
#   #   build:
#   #     context: .
#   #     dockerfile: Dockerfile.flask
#   #   image: binarykeeda-ats
#   #   ports:
#   #     - "5005:5005"
#   #   env_file:
#   #     - bk.conf

#   # paymentnode:
#   #   container_name: paymentnode

#   #   build:
#   #     context: .
#   #     dockerfile: Dockerfile
#   #   command: npm run payment

#   #   image: binarykeeda-payment
#   #   ports:
#   #     - "5009:5009"
#   #   env_file:
#   #     - bk.conf

version: "3.8"

services:
  # =========================
  # API CORE
  # =========================
  api-core-node:
    image: binarykeeda-api-core
    container_name: api_core_node
    build:
      context: .
      target: api-core

    ports:
      - "${API_PORT}:${API_PORT}"

    env_file:
      - .env

    environment:
      - PORT=${API_PORT}

    restart: unless-stopped
    mem_limit: 1g

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:${API_PORT}/health || exit 1"
        ]
      interval: 30s
      timeout: 5s
      retries: 3

  # =========================
  # EVALUATOR
  # =========================
  evaluator-node:
    image: binarykeeda-evaluator
    container_name: evaluator_node
    build:
      context: .
      target: evaluator

    ports:
      - "${EVALUATOR_PORT}:${EVALUATOR_PORT}"

    env_file:
      - .env

    environment:
      - PORT=${EVALUATOR_PORT}

    restart: unless-stopped
    cpus: 0.5
    mem_limit: 512m

  # =========================
  # WORKER
  # =========================
  worker:
    image: binarykeeda-worker
    container_name: worker
    build:
      context: .
      target: worker

    env_file:
      - .env

    restart: unless-stopped
    cpus: 0.25
    mem_limit: 256m

  # =========================
  # CAMPUS WORKER
  # =========================
  campusworker:
    image: binarykeeda-campusworker
    container_name: campusworker
    build:
      context: .
      target: campusworker

    env_file:
      - .env

    restart: unless-stopped
    cpus: 0.25
    mem_limit: 256m
